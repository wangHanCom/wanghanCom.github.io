<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue双向绑定 | 汪涵的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link>
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.98136e72.css" as="style"><link rel="preload" href="/assets/js/app.df490d21.js" as="script"><link rel="preload" href="/assets/js/2.9235f093.js" as="script"><link rel="preload" href="/assets/js/26.88fd7535.js" as="script"><link rel="prefetch" href="/assets/js/10.92f448a7.js"><link rel="prefetch" href="/assets/js/11.d81451ab.js"><link rel="prefetch" href="/assets/js/12.fe657e2d.js"><link rel="prefetch" href="/assets/js/13.673f55af.js"><link rel="prefetch" href="/assets/js/14.33419792.js"><link rel="prefetch" href="/assets/js/15.ab408685.js"><link rel="prefetch" href="/assets/js/16.41231623.js"><link rel="prefetch" href="/assets/js/17.f98cb10c.js"><link rel="prefetch" href="/assets/js/18.dc28497a.js"><link rel="prefetch" href="/assets/js/19.3bd23e42.js"><link rel="prefetch" href="/assets/js/20.48e0bcc4.js"><link rel="prefetch" href="/assets/js/21.4ca137be.js"><link rel="prefetch" href="/assets/js/22.fe35d04c.js"><link rel="prefetch" href="/assets/js/23.e2151993.js"><link rel="prefetch" href="/assets/js/24.42cdd1be.js"><link rel="prefetch" href="/assets/js/25.2ef590fe.js"><link rel="prefetch" href="/assets/js/27.aefa961a.js"><link rel="prefetch" href="/assets/js/28.5b4073a9.js"><link rel="prefetch" href="/assets/js/29.4c27b4b2.js"><link rel="prefetch" href="/assets/js/3.74014b60.js"><link rel="prefetch" href="/assets/js/30.f97becd7.js"><link rel="prefetch" href="/assets/js/31.92fc7f70.js"><link rel="prefetch" href="/assets/js/32.d7c4f275.js"><link rel="prefetch" href="/assets/js/33.8d2027ca.js"><link rel="prefetch" href="/assets/js/34.adb9aee5.js"><link rel="prefetch" href="/assets/js/35.34cb4c23.js"><link rel="prefetch" href="/assets/js/4.ddf5fb83.js"><link rel="prefetch" href="/assets/js/5.2f6ceb2d.js"><link rel="prefetch" href="/assets/js/6.acebe267.js"><link rel="prefetch" href="/assets/js/7.4f5a488b.js"><link rel="prefetch" href="/assets/js/8.d3b85309.js"><link rel="prefetch" href="/assets/js/9.395837cf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.98136e72.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">汪涵的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vueDoc/route.html" class="sidebar-link">路由</a></li><li><a href="/vueDoc/vue.html" class="sidebar-link">vue源码</a></li><li><a href="/vueDoc/vueRouter.html" class="sidebar-link">router</a></li><li><a href="/vueDoc/bindData.html" aria-current="page" class="active sidebar-link">vue双向绑定</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vueDoc/bindData.html#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/vueDoc/bindData.html#实现原理" class="sidebar-link">实现原理</a></li><li class="sidebar-sub-header"><a href="/vueDoc/bindData.html#动态绑定遇到的坑" class="sidebar-link">动态绑定遇到的坑</a></li><li class="sidebar-sub-header"><a href="/vueDoc/bindData.html#实现响应式的方式" class="sidebar-link">实现响应式的方式</a></li><li class="sidebar-sub-header"><a href="/vueDoc/bindData.html#参考链接" class="sidebar-link">参考链接</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue双向绑定"><a href="#vue双向绑定" class="header-anchor">#</a> vue双向绑定</h1> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>vue.js是采用的数据劫持结合发布者-订阅者模式的方式,通过object.defineProperty()来劫持各个属性的setter/getter 在数据变动时,发布消息给订阅者,触发相应的监听回调 。</p> <h3 id="具体步骤"><a href="#具体步骤" class="header-anchor">#</a> 具体步骤</h3> <ol><li>需要observe(观察者)的数据对象进行遍历,包括子属性对象的属性,都加上setter和getter,这样的话, 给这个对象的某个值赋值,就会触发setter,那么就能监听到数据的变化 。</li> <li>compile(解析)解析模版指令,将模版中的变量替换成数据,然后初始化渲染页面视图,并将每个指令对应的节点绑定更新函数, 添加监听数据的订阅者,一旦数据有变动,收到通知,更新视图 。</li> <li>watcher(订阅者)是observer和compile之间通信的桥梁,主要做的事情是
<ul><li>在实例化时往属性订阅器(dep)里面添加自己 。</li> <li>自身必须有一个update()方法 。</li> <li>待属性变动dep.notice()通知时,能够调用自身的update()方法,并触发compile中绑定的回调。</li></ul></li> <li>mvvm作为数据绑定的入口,整合observer,compile和watcher来监听自己的model数据变化,通过compile来解析编译模版, 最终利用watcher搭起observer和compile之间的通信桥梁,达到数据变化-&gt;更新视图:视图交互变化-&gt;数据model变更的双向绑定效果。</li></ol> <h3 id="简化版"><a href="#简化版" class="header-anchor">#</a> 简化版</h3> <ol><li>第一步：组件初始化的时候，先给每一个Data属性都注册getter，setter，也就是reactive化。然后再new 一个自己的Watcher对象，此时watcher会立即调用组件的render函数去生成虚拟DOM。在调用render的时候，就会需要用到data的属性值，此时会触发getter函数，将当前的Watcher函数注册进sub里。</li> <li>第二步：当data属性发生改变之后，就会遍历sub里所有的watcher对象，通知它们去重新渲染组件。</li></ol> <h2 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h2> <h3 id="任务拆分"><a href="#任务拆分" class="header-anchor">#</a> 任务拆分</h3> <p>拆分任务可以让我们的思路更加清晰：<br>（1）将vue中的data中的内容绑定到输入文本框和文本节点中（解析{{}}指令）<br>（2）当文本框的内容改变时，vue实例中的data也同时发生改变<br>（3）当data中的内容发生改变时，输入框及文本节点的内容也发生变化<br></p> <h3 id="绑定内容"><a href="#绑定内容" class="header-anchor">#</a> 绑定内容</h3> <p>通过DocuemntFragment（碎片化文档）劫持所有的子节点，然后对每一个节点进行处理，看是不是有跟vm实例中有关联的内容，如果有，修改这个节点的内容。然后重新添加入DocumentFragment中。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code> <span class="token keyword">function</span> <span class="token function">nodeToFragment</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span>vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> child<span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>child <span class="token operator">=</span> node<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//在向碎片化文档中添加节点时，每个节点都处理一下。</span>
            <span class="token function">compile</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//***对每一个节点进行处理</span>
            fragment<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> fragment<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">/***************************使用****************************/</span>
<span class="token comment">//在vue初始化的时候调用</span>
<span class="token keyword">function</span> <span class="token function">vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//...</span>
   <span class="token keyword">var</span> id <span class="token operator">=</span> options<span class="token punctuation">.</span>el
   <span class="token keyword">var</span> dom <span class="token operator">=</span> <span class="token function">nodeToFragment</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token comment">//***</span>
   <span class="token comment">//处理完所有的dom节点后，重新将内容添加回去</span>
   document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="view变换-model变化"><a href="#view变换-model变化" class="header-anchor">#</a> view变换 =&gt; model变化</h3> <p>通过事件监听器keyup，input等，来获取到最新的value，然后通过Object.defineProperty将获取的最新的value，赋值给实例vm的text。<br>修改输入框内容 =&gt; 在事件回调函数中修改属性值 =&gt; 触发属性的 set 方法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span>vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token comment">//...</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token comment">//...</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>attr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>attr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>nodeName <span class="token operator">==</span> <span class="token string">'v-model'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//属性名为v-model</span>
                    <span class="token comment">//...</span>
                    node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//***</span>
                        vm<span class="token punctuation">[</span>value<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token comment">//将实例的text修改为最新值,此时会触发set</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                   <span class="token comment">//...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果是文本节点</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><strong>把vm实例中的data下的text通过Object.defineProperty设置为访问器属性，这样给vm.text赋值，就触发了set。</strong><br>先实现一个响应式监听属性的函数。一旦有赋新值就发生变化</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">observer</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span>vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//实现一个观察者，对每一个实例的每个属性值都进行观察</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//遍历对象的每个key，变成响应式</span>
            <span class="token function">defineReactive</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>key<span class="token punctuation">,</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//***</span>
        <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span>key<span class="token punctuation">,</span>val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        object<span class="token punctuation">.</span><span class="token function">definProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token punctuation">{</span>
            <span class="token function-variable function">get</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> val<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">set</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//给vm[key]赋值时就会触发 set</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>newVal <span class="token operator">==</span> val<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                val <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">/***************************使用****************************/</span>
<span class="token comment">//在vue初始化的时候调用</span>
<span class="token keyword">function</span> <span class="token function">vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> options<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
     <span class="token function">observer</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">//***</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="model变化-view变化"><a href="#model变化-view变化" class="header-anchor">#</a> model变化 =&gt; view变化</h3> <p>修改vm实例的属性 该改变输入框的内容 与 文本节点的内容。在页面中多处用到 data中的属性，这是1对多的。也就是说，改变1个model的值可以改变多个view中的值。<br>这就需要我们引入一个新的知识点：</p> <h4 id="订阅-发布者模式"><a href="#订阅-发布者模式" class="header-anchor">#</a> 订阅/发布者模式</h4> <p>订阅发布模式（又称观察者模式）定义了一种一对多的关系，让多个观察者同时监听某一个主题对象，这个主题对象的状态发生改变时就会通知所有观察者对象。发布者发出通知 =&gt; 主题对象收到通知并推送给订阅者 =&gt; 订阅者执行相应操作<br>
发出通知 dep.notify() =&gt; 触发订阅者的 update 方法 =&gt; 更新视图</p> <p>对compile做以下修改</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span>vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token comment">//...</span>
        <span class="token comment">//如果是文本节点</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//...</span>
            <span class="token comment">//node.nodeValue=vm[name]; //删除这一段</span>
            <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>node<span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token comment">//不直接通过赋值，通过绑定一个订阅者</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>对defineReactive做以下修改</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span>key<span class="token punctuation">,</span>val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">var</span> dep<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//***新增</span>
        object<span class="token punctuation">.</span><span class="token function">definProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>key<span class="token punctuation">,</span><span class="token punctuation">{</span>
            <span class="token function-variable function">get</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//***新增 get 方法中将该 watcher 添加到了对应访问器属性的 dep 中（Watcher中会触发）</span>
                    dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> val<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">set</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//给vm[key]赋值时就会触发 set</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>newVal <span class="token operator">==</span> val<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                val <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
                <span class="token comment">//一旦更新马上通知</span>
                dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//***新增  触发所有订阅者的更新update方法</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
   <span class="token comment">//      dep构造函数</span>
        <span class="token keyword">function</span> <span class="token function">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Dep</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre></div><p>Watcher的实现</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Watcher</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>node<span class="token punctuation">,</span>name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        Dep<span class="token punctuation">.</span>target <span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token operator">=</span>vm<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token operator">=</span>node<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token operator">=</span>name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Dep<span class="token punctuation">.</span>target<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//dep.notify()中会调用</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>nodeValue<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token comment">//更改节点内容的关键</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//在update中调用</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//读取了 vm 的访问器属性，从而触发了访问器属性的 get 方法。get 方法中将该 watcher 添加到了对应访问器属性的 dep 中</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="vue2-x版本响应式实现方案的弊端"><a href="#vue2-x版本响应式实现方案的弊端" class="header-anchor">#</a> vue2.x版本响应式实现方案的弊端</h3> <p>通过我们的分析，也就看到了vue2.x版本响应式实现的弊端：</p> <ol><li>Object.defineProperty()这个api无法原生的对数组进行响应式监听</li> <li>实现过程中对于深度嵌套的数据，递归消耗大量性能</li> <li>我们注意到，Object.defineProperty()这种实现，以及数组的实现，都存在一个问题，那就是没办法监听到后续的手动新增删除属性元素，比如数组，直接通过索引去设置和改变值是不会触发视图更新的，当然vue为我们提供了vue.set和vue.delete这样的api，但终究是不方便的</li></ol> <h2 id="动态绑定遇到的坑"><a href="#动态绑定遇到的坑" class="header-anchor">#</a> 动态绑定遇到的坑</h2> <h3 id="发生背景"><a href="#发生背景" class="header-anchor">#</a> 发生背景</h3> <p>在一个表格中嵌套复选框，点过全选后取消，再点击单个复选框值有改变，但是界面上复选框没有更新选中状态。</p> <p><img src="'./img/img3.png'" alt=""></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code> <span class="token keyword">this</span><span class="token punctuation">.</span>dataList <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seatList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//第一次修改 []-》this.seatList</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dataList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">//第二次修改 item对象增加checked字段</span>
            item<span class="token punctuation">.</span>checked <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token keyword">return</span> item
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>原因：服务端返回的数据中没有checked字段，第一次赋值的时候是没有checked字段的对象数组，vue监听到dataList由<code>[]=&gt;[{},{}]</code>（相当于触发push），触发了[]的set方法，对新值<code>[{},{}]</code>的进行递归调用监听到{}中的每个对象key。<br> <img src="'./img/img2.png'" alt=""></p> <p>由上图可知，虽然马上遍历每个对象添加checked属性，但是vue没有对checked设置set和get方法。
<code>Object.defineProperty()</code>这种实现，以及数组的实现，都存在一个问题，那就是没办法监听到后续的手动新增删除属性元素。</p> <p><strong>解决</strong></p> <ol><li>在开始初始化数据的时候，先添加checked属性再赋值到data上。</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>seatList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">//将数据手动添加check属性后</span>
       item<span class="token punctuation">.</span>checked <span class="token operator">=</span> <span class="token boolean">false</span>
       <span class="token keyword">return</span> item
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>dataList <span class="token operator">=</span> data <span class="token comment">//一次性赋值给dataList，对每个属性进行绑定</span>
</code></pre></div><ol start="2"><li>直接对check属性做监听</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code> <span class="token keyword">this</span><span class="token punctuation">.</span>dataList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//item.checked = false</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$<span class="token keyword">set</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">'checked'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// 这里，给对象添加属性，用$set方法。</span>
        <span class="token keyword">return</span> item
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="'./img/img1.png'" alt=""></p> <h2 id="实现响应式的方式"><a href="#实现响应式的方式" class="header-anchor">#</a> 实现响应式的方式</h2> <h2 id="参考链接"><a href="#参考链接" class="header-anchor">#</a> 参考链接</h2> <ol><li><a href="https://www.cnblogs.com/lovemomo/p/11589929.html" target="_blank" rel="noopener noreferrer">vue与element ui的el-checkbox的坑 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://juejin.im/post/6844903957807169549" target="_blank" rel="noopener noreferrer">Vue3 中的数据侦测<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.jianshu.com/p/e7ebb1500613" target="_blank" rel="noopener noreferrer">理解VUE双向数据绑定原理和实现---赵佳乐<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vueDoc/vueRouter.html" class="prev">
        router
      </a></span> <span class="next"><a href="/webpack/devServer.html">
        devServer
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.df490d21.js" defer></script><script src="/assets/js/2.9235f093.js" defer></script><script src="/assets/js/26.88fd7535.js" defer></script>
  </body>
</html>
